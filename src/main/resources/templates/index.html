<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@5"
      rel="stylesheet"
      type="text/css"
    />
    <script
      src="https://unpkg.com/htmx.org@2.0.4"
      integrity="sha384-HGfztofotfshcF7+8n44JQL2oJmowVChPTg48S+jvZoztPfvwD79OC/LTtG6dMp+"
      crossorigin="anonymous"
    ></script>

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>
  <body class="flex w-full h-screen justify-center bg-gray-100 p-10">
    <div class="container">
      <div class="w-800">
        <h1>Spring Boot + MSAL.js</h1>
        <!-- TODO fix scoped function call -->
        <button id="loginButton" class="btn" onclick="signIn()">
          Login with Azure AD
        </button>
        <!-- TODO fix scoped function call -->
        <button id="refreshTokenButton" class="btn" onclick="refreshToken()">
          Refresh Token
        </button>
      </div>

      Hello, this is a simple HTML page served by Spring Boot!
      <p th:text="${user.name}"></p>
      <p>authenticated:&nbsp;<span th:text="${user.authenticated}"></span></p>

      <button hx-get="/secure">Put To Messages</button>
    </div>

    <script type="module" th:inline="javascript">
      import { PublicClientApplication } from "https://cdn.jsdelivr.net/npm/@azure/msal-browser@4.13.1/+esm";

      let response;

      const msalConfig = {
        auth: {
          clientId: "4aa95498-a8b7-4227-89f0-463eb90015a7",
          authority:
            "https://login.microsoftonline.com/40fe86af-6ef5-4f98-afac-d84bc53212dd",
          redirectUri: "http://localhost:8080/login/oauth2/code/azure/",
        },
      };
      const loginRequest = {
        scopes: ["api://4aa95498-a8b7-4227-89f0-463eb90015a7/access_as_user"],
      };

      const msalInstance = new PublicClientApplication(msalConfig);

      await msalInstance.initialize();

      async function signIn() {
        try {
          response = await msalInstance.loginPopup(loginRequest);
          console.log("Login successful:", response);
          return response;
        } catch (error) {
          console.error("Login failed:", error);
        }
      }

      async function refreshToken() {
        try {
          const accounts = msalInstance.getAllAccounts();
          if (accounts.length === 0) {
            console.log("No accounts found, signing in...");
            await signIn();
            return;
          }
          response = await msalInstance.acquireTokenSilent({
            ...loginRequest,
            account: accounts[0],
          });
          console.log("Token refreshed:", response);

          return response;
        } catch (error) {
          console.warn(
            "Silent token acquisition failed, falling back to interactive login.",
            error
          );
          return signIn();
        }
      }

      // Dealy htmx request until the auth promise has resolved
      // @see https://htmx.org/examples/async-auth/
      htmx.on("htmx:confirm", (e) => {
        // if there is no auth token
        if (response == null) {
          // stop the regular request from being issued
          e.preventDefault();
          // only issue it once the auth promise has resolved
          refreshToken().then(() => e.detail.issueRequest());
        }
      });

      // add the auth token to the request as a header
      htmx.on("htmx:configRequest", (e) => {
        e.detail.headers["Authorization"] = `Bearer ${response.accessToken}`;
      });

      await refreshToken();
    </script>
  </body>
</html>
